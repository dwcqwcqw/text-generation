(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{1609:function(e,t,s){Promise.resolve().then(s.bind(s,6406))},6406:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return ChatPage}});var a=s(7437),o=s(2265),n=s(9883),l=s(1827),r=s(3966),i=s(3523),c=s(6245),u=s(5817),d=s(4280),g=s(7972),m=s(6020),h=s(7393);let D={baseUrl:"https://api-text-generation.runpod.app",endpoints:{saveChat:"/chat/save",loadChat:"/chat/load",listChats:"/chat/history",healthCheck:"/health"}};function generateChatId(){return"chat_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}function formatChatRecord(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return{id:generateChatId(),timestamp:new Date().toISOString(),messages:e.map(e=>({...e,timestamp:e.timestamp||new Date().toISOString()})),metadata:{version:"1.0",model:t.model||"unknown",...t}}}async function saveChatToR2(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let s=formatChatRecord(e,t);console.log("\uD83D\uDCBE 通过后端API保存聊天记录到R2:",s.id);let a=await fetch("".concat(D.baseUrl).concat(D.endpoints.saveChat),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:s.id,messages:s.messages,metadata:s.metadata})});if(a.ok){let e=await a.json();return console.log("✅ 聊天记录保存成功:",s.id),{success:!0,chatId:s.id,result:e}}{let e=await a.text();throw Error("HTTP ".concat(a.status,": ").concat(e))}}catch(s){console.error("❌ 保存聊天记录失败:",s);try{let s=formatChatRecord(e,t),a="chat_backup_".concat(s.id);return localStorage.setItem(a,JSON.stringify(s)),console.log("\uD83D\uDCF1 已保存到本地存储作为备份:",a),{success:!0,chatId:s.id,storage:"local_backup"}}catch(e){return console.error("❌ 本地备份也失败:",e),{success:!1,error:s.message}}}}async function checkAPIHealth(){try{let e=await fetch("".concat(D.baseUrl).concat(D.endpoints.healthCheck));return e.ok}catch(e){return console.log("⚠️ 后端API不可用，将使用本地存储备份"),!1}}async function autoSaveChatHistory(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e||e.length<2)return{success:!1,error:"消息太少，不需要保存"};let s=e.find(e=>"user"===e.role),a=s?s.content.substring(0,30)+(s.content.length>30?"...":""):"新对话",o=await checkAPIHealth();if(o){let s=await saveChatToR2(e,t);if(s.success)return console.log("\uD83D\uDCBE 聊天记录自动保存完成 (R2):",s.chatId),s}try{let s=formatChatRecord(e,t),o="chat_backup_".concat(s.id);return localStorage.setItem(o,JSON.stringify(s)),console.log("\uD83D\uDCF1 聊天记录自动保存完成 (本地):",s.id),{success:!0,chatId:s.id,storage:"local",title:a}}catch(e){return console.error("❌ 本地存储失败:",e),{success:!1,error:e.message}}}function exportChatAsJSON(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{let s=formatChatRecord(e),a=JSON.stringify(s,null,2),o=new Blob([a],{type:"application/json"}),n=URL.createObjectURL(o),l=document.createElement("a");return l.href=n,l.download=t||"chat_".concat(s.id,".json"),document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(n),console.log("\uD83D\uDCBE 聊天记录已导出为JSON文件"),{success:!0,filename:l.download}}catch(e){return console.error("❌ 导出失败:",e),{success:!1,error:e.message}}}var x=s(2601);let p=[{id:"L3.2-8X3B",name:"L3.2-8X3B.gguf",description:"18.4B参数模型",parameters:"/runpod-volume/text_models/L3.2-8X3B.gguf"},{id:"L3.2-8X4B",name:"L3.2-8X4B.gguf",description:"21B参数模型",parameters:"/runpod-volume/text_models/L3.2-8X4B.gguf"}];function ChatPage(){let[e,t]=(0,o.useState)([]),[s,D]=(0,o.useState)(null),[f,y]=(0,o.useState)(""),[b,w]=(0,o.useState)(!1),[v,j]=(0,o.useState)(p[0]),[N,S]=(0,o.useState)(!1),[C,A]=(0,o.useState)(""),[I,E]=(0,o.useState)([]),[P,k]=(0,o.useState)(!0),[T,_]=(0,o.useState)(null),[M,O]=(0,o.useState)("none"),[R,B]=(0,o.useState)(null),L=(0,o.useRef)(null);(0,o.useEffect)(()=>{console.log("\uD83D\uDD0D 模型验证 v2.0:",{modelCount:p.length,models:p.map(e=>({id:e.id,name:e.name})),selectedModel:v.id}),2!==p.length&&console.error("❌ 模型数量错误！应该只有2个模型")},[v]),(0,o.useEffect)(()=>{s?console.log("\uD83D\uDD04 初始化：已有对话，跳过创建",s.id):(console.log("\uD83D\uDD04 初始化：创建新对话"),createNewChat())},[]),(0,o.useEffect)(()=>{console.log("\uD83E\uDDEA currentSession 更新:",s?{id:s.id,title:s.title,messagesCount:s.messages.length}:"null")},[s]),(0,o.useEffect)(()=>{if(""===C.trim())E(e);else{let t=e.filter(e=>e.title.toLowerCase().includes(C.toLowerCase())||e.messages.some(e=>e.content.toLowerCase().includes(C.toLowerCase())));E(t)}},[C,e]);let scrollToBottom=()=>{var e;null===(e=L.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})};(0,o.useEffect)(()=>{scrollToBottom()},[null==s?void 0:s.messages]);let createNewChat=()=>{if(s&&0===s.messages.length)return;let e={id:Date.now().toString(),title:"New Chat",messages:[],createdAt:new Date,lastMessage:new Date};t(t=>[e,...t]),D(e)},generateChatTitle=e=>{let t=e.trim().split(/\s+/).slice(0,4),s=t.join(" ");return s.length>20?s.substring(0,17)+"...":s},updateSessionTitle=(e,a)=>{let o=generateChatTitle(a);t(t=>t.map(t=>t.id===e.id?{...t,title:o,lastMessage:new Date}:t)),(null==s?void 0:s.id)===e.id&&D(e=>e?{...e,title:o,lastMessage:new Date}:null)},regenerateLastMessage=async()=>{if(!s||s.messages.length<2)return;let e=s.messages,a=e[e.length-2];if("user"!==a.role)return;let o=e.slice(0,-1),n={...s,messages:o};D(n),t(e=>e.map(e=>e.id===s.id?n:e)),await generateResponse(a.content,o)},generateResponse=async function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];w(!0);let o={id:Date.now().toString(),content:e,role:"user",timestamp:new Date},n=null==s?void 0:s.id;console.log("\uD83D\uDD04 开始生成回复，当前会话ID:",n);let l=s;if(s){let r=[...a,o];D(l={...s,messages:r,lastMessage:new Date}),t(e=>e.map(e=>e.id===n?l:e)),0===a.length&&updateSessionTitle(s,e)}let r="rpa_YT0BFBFZYAZMQHR231H4DOKQEOAJXSMVIBDYN4ZQ1tdxlb";console.log("\uD83D\uDD11 RUNPOD_API_KEY直接设置为:",r?"".concat(r.substring(0,15),"..."):"NULL");let i=x.env.NEXT_PUBLIC_RUNPOD_ENDPOINT_ID||x.env.RUNPOD_ENDPOINT_ID||"4cx6jtjdx6hdhr",c=x.env.NEXT_PUBLIC_VITE_API_BASE_URL||x.env.VITE_API_BASE_URL||"https://api.runpod.ai/v2",u="".concat(c,"/").concat(i,"/runsync");console.log("Using API Key:",r?"".concat(r.substring(0,10),"..."):"NONE");let d=null;try{if(console.log("RunPod API Configuration:",{endpoint:u,hasApiKey:!!r,selectedModel:v,endpointId:i}),r)try{(null==s?void 0:s.id)!==n&&console.warn("⚠️ API调用前会话ID已变化，从",n,"变为",null==s?void 0:s.id);let o=a.map(e=>({role:e.role,content:"string"==typeof e.content?e.content:String(e.content||"")})).filter(e=>{let t=e.content.trim();return""!==t&&"[object Object]"!==t&&"undefined"!==t&&"null"!==t});console.log("\uD83D\uDDC2️ 过滤后的对话历史:",o);let i="default";"L3.2-8X3B"===v.id?i="default":"L3.2-8X4B"===v.id&&(i="default");let c={input:{prompt:e,system_template:i,history:o,max_tokens:1e3,temperature:.7,model_path:v.parameters,stream:!1}};if(console.log("\uD83D\uDCE4 发送到RunPod的请求:",{endpoint:u,selectedModelId:v.id,payload:c}),d={id:Date.now().toString(),content:"",role:"assistant",timestamp:new Date,model:v.id},l){if((null==s?void 0:s.id)!==n){if(console.warn("⚠️ 添加AI响应前会话ID已变化，从",n,"变为",null==s?void 0:s.id),s){let e=[...s.messages,d],a={...s,messages:e,lastMessage:new Date};D(a),t(e=>e.map(e=>e.id===s.id?a:e))}}else{let e=[...l.messages,d];l={...l,messages:e,lastMessage:new Date},D(l),t(e=>e.map(e=>e.id===l.id?l:e))}}let g=await fetch(u,{method:"POST",headers:{Authorization:"Bearer ".concat(r),"Content-Type":"application/json"},body:JSON.stringify(c)});if(console.log("\uD83D\uDCE1 RunPod响应状态:",g.status),g.ok)try{let e=await g.json();console.log("\uD83D\uDCE6 RunPod完整响应:",JSON.stringify(e,null,2));let a="";if(console.log("\uD83D\uDD0D 开始解析响应..."),console.log("\uD83D\uDD0D data类型:",typeof e),console.log("\uD83D\uDD0D data内容:",e),e&&"object"==typeof e){console.log("✅ data是有效对象");try{if(console.log("\uD83D\uDD0D output存在:","output"in e),console.log("\uD83D\uDD0D output类型:",typeof e.output),console.log("\uD83D\uDD0D output内容:",e.output),null!==e.output&&void 0!==e.output){if(console.log("✅ 发现output字段，开始处理"),"object"==typeof e.output&&null!==e.output){if(console.log("\uD83D\uDD0D output是对象类型，尝试提取内容"),"model_info"in e.output&&"output"in e.output)a=String(e.output.output).trim(),console.log("✅ 从model_info/output格式提取的响应:",a);else if(e.output.text)a=String(e.output.text).trim(),console.log("✅ 从text字段提取的响应:",a);else if(e.output.response)a=String(e.output.response).trim(),console.log("✅ 从response字段提取的响应:",a);else if(e.output.content)a=String(e.output.content).trim(),console.log("✅ 从content字段提取的响应:",a);else{let t=JSON.stringify(e.output);console.log("⚠️ 未找到标准字段，使用JSON字符串:",t);try{let e=JSON.parse(t);a="string"==typeof e?e:e&&"object"==typeof e?e.text?String(e.text):e.content?String(e.content):e.message?String(e.message):e.response?String(e.response):e.result?String(e.result):e.output?String(e.output):t:t}catch(e){console.error("⚠️ JSON解析失败，使用原始字符串:",e),a=t}}}else a=String(e.output).trim(),console.log("✅ 直接使用非对象output:",a)}else e.result?(console.log("⚠️ 没有output，尝试使用result字段"),a=String(e.result).trim(),console.log("\uD83D\uDCE4 使用result:",a)):(console.log("❌ 没有找到output或result字段"),console.log("\uD83D\uDD0D 可用字段:",Object.keys(e)),a="抱歉，服务器返回了无效的响应格式。\uD83D\uDE14")}catch(t){console.error("❌ 响应解析错误:",t),a=JSON.stringify(e),console.log("⚠️ 使用整个数据对象作为字符串:",a)}}else console.log("❌ data不是有效对象"),a="抱歉，服务器返回了无效的数据格式。\uD83D\uDE14";if(console.log("\uD83C\uDFAF 解析完成，最终AI响应:",a),console.log("\uD83C\uDFAF AI响应类型:",typeof a),console.log("\uD83C\uDFAF AI响应长度:",a.length),"string"!=typeof a&&(console.log("⚠️ aiResponse不是字符串，强制转换:",typeof a),a=String(a)),a&&"[object Object]"!==a&&"undefined"!==a&&"null"!==a&&""!==a.trim()||(console.log("❌ AI响应无效或为空，使用默认消息"),a="抱歉，我无法生成回复，请重试。\uD83D\uDE14"),console.log("\uD83C\uDFAF 最终确认的AI响应 (字符串):",a),console.log("\uD83C\uDFAF 字符串长度:",a.length),!d&&(d={id:Date.now().toString(),content:"",role:"assistant",timestamp:new Date,model:v.id},l)){if((null==s?void 0:s.id)!==n){if(console.warn("⚠️ 添加AI响应前会话ID已变化，从",n,"变为",null==s?void 0:s.id),s){let e=[...s.messages,d],a={...s,messages:e,lastMessage:new Date};D(a),t(e=>e.map(e=>e.id===s.id?a:e))}}else{let e=[...l.messages,d];l={...l,messages:e,lastMessage:new Date},D(l),t(e=>e.map(e=>e.id===l.id?l:e))}}if(a&&d)try{await simulateStreamingResponse(a,d),w(!1);return}catch(e){if(console.error("❌ 流式响应错误:",e),s&&d){let e=s.messages.map(e=>e.id===(null==d?void 0:d.id)?{...e,content:a}:e),o={...s,messages:e,lastMessage:new Date};D(o),t(e=>e.map(e=>e.id===s.id?o:e))}}}catch(a){console.error("❌ 处理API响应时出错:",a);let e={id:Date.now().toString(),content:"抱歉，处理API响应时出错。请重试。\uD83D\uDE14",role:"assistant",timestamp:new Date,model:v.id};if(s){let a=[...s.messages,e],o={...s,messages:a,lastMessage:new Date};D(o),t(e=>e.map(e=>e.id===s.id?o:e))}}else{let e=await g.text();console.error("❌ RunPod API错误:",g.status,e);let a={id:Date.now().toString(),content:"抱歉，API请求失败 (".concat(g.status,"): ").concat(e||"未知错误"),role:"assistant",timestamp:new Date,model:v.id};if(s){let e=[...s.messages,a],o={...s,messages:e,lastMessage:new Date};D(o),t(e=>e.map(e=>e.id===s.id?o:e))}}}catch(e){console.error("❌ RunPod API调用异常:",e)}console.log("\uD83E\uDD16 使用模拟AI响应"),await new Promise(e=>setTimeout(e,1e3+2e3*Math.random()));let o=['好的，关于"'.concat(e,'"这个问题，让我想想... \uD83E\uDD14'),'我理解您询问"'.concat(e,'"的意思，这是我的想法： \uD83D\uDCAD'),'关于"'.concat(e,'"，我可以分享一些见解： ✨'),'这是个很好的话题！关于"'.concat(e,'"，以下是我的想法： \uD83C\uDFAF'),'感谢您的问题"'.concat(e,'"，这是我的观点： \uD83D\uDCDD')],c=["这是一个复杂的话题，涉及多个方面。需要考虑用户体验、技术实现和整体系统设计等关键因素。\uD83D\uDD27","有几种方法可以考虑，每种都有其优势和潜在挑战，我们应该仔细评估。⚖️","这需要一个平衡的方法，既要考虑当前的功能需求，也要考虑未来的可扩展性。\uD83D\uDE80","最有效的解决方案可能是结合现代最佳实践和经过验证的方法论。\uD83D\uDCA1","这是一个需要仔细规划和迭代开发才能取得优秀结果的领域。\uD83C\uDFA8"],g=["您希望我详细解释某个特定方面吗？\uD83E\uDD17","您对这种方法有什么想法？\uD83D\uDCAC","有什么特定的领域您想进一步探讨吗？\uD83D\uDD0D","这有助于回答您的问题吗？✅","如果您需要更多细节，请告诉我。\uD83D\uDCDA"],m=o[Math.floor(Math.random()*o.length)],h=c[Math.floor(Math.random()*c.length)],x=g[Math.floor(Math.random()*g.length)],p="".concat(m,"\n\n").concat(h,"\n\n").concat(x);if(!d&&(d={id:Date.now().toString(),content:"",role:"assistant",timestamp:new Date,model:v.id},l)){let e=[...l.messages,d];l={...l,messages:e,lastMessage:new Date},D(l),t(e=>e.map(e=>e.id===l.id?l:e))}await simulateStreamingResponse(p,d)}catch(a){console.error("\uD83D\uDCA5 生成响应时出错:",a);let e={id:Date.now().toString(),content:"抱歉，我遇到了一个错误：".concat(a instanceof Error?a.message:"未知错误"," \uD83D\uDE14"),role:"assistant",timestamp:new Date};if(s){let a=[...s.messages,e],o={...s,messages:a};D(o),t(e=>e.map(e=>e.id===s.id?o:e))}}w(!1)},simulateStreamingResponse=async(e,a)=>{try{let o=null==s?void 0:s.id;console.log("\uD83D\uDD04 开始流式显示，会话ID:",o,"消息ID:",a.id);let n=e.split(" "),l="";for(let e=0;e<n.length;e++){if(l+=(e>0?" ":"")+n[e],s&&(e%5==0||e===n.length-1))try{s.id!==o&&console.warn("⚠️ 会话ID已变化，从",o,"变为",s.id);let r=s.messages.some(e=>e.id===a.id);if(!r){console.warn("⚠️ 消息ID不存在于当前会话中:",a.id);let o={...a,content:l},r=[...s.messages,o],i={...s,messages:r,lastMessage:new Date};D(i),e===n.length-1&&t(e=>e.map(e=>e.id===s.id?i:e));continue}let i=s.messages.map(e=>e.id===a.id?{...e,content:l}:e),c={...s,messages:i,lastMessage:new Date};D(c),e===n.length-1&&t(e=>e.map(e=>e.id===s.id?c:e))}catch(e){console.error("❌ 更新消息内容失败:",e)}await new Promise(e=>setTimeout(e,30+50*Math.random()))}P&&s&&s.messages.length>=2&&setTimeout(async()=>{try{if((null==s?void 0:s.id)!==o){console.warn("⚠️ 自动保存时会话ID已变化，取消保存");return}O("saving"),console.log("\uD83D\uDCBE 自动保存聊天记录到R2...");let e=await autoSaveChatHistory(s.messages,{model:v.id,persona:"default",temperature:.7,timestamp:new Date().toISOString()});e.success?(console.log("✅ 聊天记录已保存到R2:",e.chatId),_(new Date),O("storage"in e&&"local"===e.storage?"local":"saved")):(console.error("❌ 聊天记录保存失败:","error"in e?e.error:"Unknown error"),O("error"))}catch(e){console.error("❌ 自动保存异常，但继续显示消息:",e),O("error")}},1e3)}catch(o){if(console.error("❌ 流式响应处理错误:",o),s)try{let o=s.messages.some(e=>e.id===a.id);if(o){let o=s.messages.map(t=>t.id===a.id?{...t,content:e}:t),n={...s,messages:o,lastMessage:new Date};D(n),t(e=>e.map(e=>e.id===s.id?n:e))}else{let o={...a,content:e},n=[...s.messages,o],l={...s,messages:n,lastMessage:new Date};D(l),t(e=>e.map(e=>e.id===s.id?l:e))}}catch(e){console.error("❌ 最终更新消息失败:",e)}}},handleSendMessage=async()=>{if(!f.trim()||b||!s)return;let e=f.trim();y(""),await generateResponse(e,s.messages)},testApiKeyDirect=async()=>{console.log("\uD83E\uDDEA Direct API Key Test Started");let e="rpa_YT0BFBFZYAZMQHR231H4DOKQEOAJXSMVIBDYN4ZQ1tdxlb";console.log("\uD83D\uDD11 Test API Key:",e?"".concat(e.substring(0,15),"..."):"NULL");try{let t=await fetch("https://api.runpod.ai/v2/4cx6jtjdx6hdhr/runsync",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({input:{prompt:"Direct test from main page"}})});if(console.log("\uD83E\uDDEA Test Response Status:",t.status),t.ok){let e=await t.json();console.log("\uD83E\uDDEA Test Response Data:",e),alert("✅ API Test Success!\nOutput: ".concat(e.output))}else console.log("\uD83E\uDDEA Test Error:",await t.text()),alert("❌ API Test Failed: ".concat(t.status))}catch(e){console.log("\uD83E\uDDEA Test Exception:",e),alert("❌ API Test Exception: ".concat(e))}};return(0,a.jsxs)("div",{className:"h-screen flex bg-white",children:[(0,a.jsxs)("div",{className:"w-80 bg-white border-r border-gray-200 flex flex-col",children:[(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-black",children:"CHAT A.I+"}),(0,a.jsx)("a",{href:"/test",className:"text-sm text-blue-600 hover:text-blue-800 underline mt-2 block",children:"\uD83D\uDD27 API 测试页面"})]}),(0,a.jsx)("div",{className:"px-6 mb-6",children:(0,a.jsxs)("button",{onClick:createNewChat,className:"w-full flex items-center gap-3 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium",children:[(0,a.jsx)(n.Z,{size:18}),"New chat"]})}),(0,a.jsx)("div",{className:"px-6 mb-6",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(l.Z,{size:18,className:"absolute left-3 top-3 text-gray-400"}),(0,a.jsx)("input",{type:"text",placeholder:"Search conversations...",value:C,onChange:e=>A(e.target.value),className:"w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto px-6",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-600 mb-3",children:"Your conversations"}),(0,a.jsx)("div",{className:"space-y-2",children:e.map(e=>(0,a.jsx)("button",{onClick:()=>{D(e)},className:"w-full text-left p-3 rounded-lg transition-colors ".concat((null==s?void 0:s.id)===e.id?"bg-blue-500 text-white":"bg-gray-100 hover:bg-gray-200 text-gray-800"),children:(0,a.jsx)("div",{className:"flex items-center justify-between",children:(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("h3",{className:"font-medium truncate",children:e.title&&"New Chat"!==e.title?e.title:"新对话"}),(0,a.jsx)("p",{className:"text-sm opacity-75 truncate",children:e.messages.length>0?"".concat(e.messages.length," 条消息"):"开始对话..."}),(0,a.jsx)("p",{className:"text-xs opacity-60",children:e.lastMessage.toLocaleDateString()})]})})},e.id))})]}),(0,a.jsx)("div",{className:"p-6 border-t border-gray-200",children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsxs)("button",{onClick:()=>S(!N),className:"w-full flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-gray-600 rounded-lg flex items-center justify-center",children:(0,a.jsx)(r.Z,{size:18,className:"text-white"})}),(0,a.jsxs)("div",{className:"text-left",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900",children:v.name}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:v.parameters})]})]}),(0,a.jsx)(i.Z,{size:18,className:"text-gray-400"})]}),N&&(0,a.jsx)("div",{className:"absolute bottom-full left-0 right-0 mb-2 bg-white border border-gray-200 rounded-lg shadow-xl z-20",children:p.map(e=>(0,a.jsxs)("button",{onClick:()=>{j(e),S(!1)},className:"w-full text-left p-4 hover:bg-gray-50 first:rounded-t-lg last:rounded-b-lg transition-colors",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900",children:e.name}),(0,a.jsx)("p",{className:"text-xs text-gray-500",children:e.description})]},e.id))})]})})]}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col bg-white",children:[s&&s.messages.length>0&&(0,a.jsx)("div",{className:"px-6 py-4 border-b border-gray-200 bg-white",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-900",children:s.title}),T&&(0,a.jsxs)("p",{className:"text-xs text-green-600 mt-1",children:["\uD83D\uDCBE 已保存到R2: ",T.toLocaleTimeString()]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:["none"!==M&&(0,a.jsxs)("div",{className:"flex items-center gap-1 text-xs px-2 py-1 rounded-lg ".concat("saving"===M?"bg-yellow-100 text-yellow-700":"saved"===M?"bg-green-100 text-green-700":"local"===M?"bg-blue-100 text-blue-700":"error"===M?"bg-red-100 text-red-700":""),children:["saving"===M&&"⏳ 保存中...","saved"===M&&"✅ 已保存到云端","local"===M&&"\uD83D\uDCF1 已保存到本地","error"===M&&"❌ 保存失败"]}),(0,a.jsxs)("label",{className:"flex items-center gap-2 text-sm text-gray-600",children:[(0,a.jsx)("input",{type:"checkbox",checked:P,onChange:e=>k(e.target.checked),className:"rounded"}),"自动保存"]}),s.messages.length>=2&&(0,a.jsxs)("button",{onClick:async()=>{try{O("saving");let e=await autoSaveChatHistory(s.messages,{model:v.id,persona:"default",temperature:.7});e.success?(_(new Date),O("storage"in e&&"local"===e.storage?"local":"saved"),alert("✅ 聊天记录已保存")):(O("error"),alert("❌ 保存失败: "+("error"in e?e.error:"Unknown error")))}catch(e){O("error"),alert("❌ 保存异常: "+e)}},className:"flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors",children:[(0,a.jsx)(c.Z,{size:16}),"保存"]}),s.messages.length>0&&(0,a.jsxs)("button",{onClick:()=>exportChatAsJSON(s.messages),className:"flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors",children:[(0,a.jsx)(u.Z,{size:16}),"导出"]}),s.messages.length>1&&(0,a.jsxs)("button",{onClick:regenerateLastMessage,disabled:b,className:"flex items-center gap-2 px-4 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50",children:[(0,a.jsx)(d.Z,{size:16}),"重新生成"]})]})]})}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto bg-gray-50",children:s&&0!==s.messages.length?(0,a.jsxs)("div",{className:"p-6 space-y-6 max-w-4xl mx-auto w-full",children:[s.messages.map(e=>{var t;return(0,a.jsxs)("div",{className:"flex gap-4 message-bubble ".concat("user"===e.role?"justify-end":"justify-start"),children:["assistant"===e.role&&(0,a.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0",children:(0,a.jsx)(r.Z,{size:16,className:"text-white"})}),(0,a.jsxs)("div",{className:"max-w-2xl p-4 rounded-2xl ".concat("user"===e.role?"bg-blue-600 text-white":"bg-white text-gray-900 border border-gray-200"),children:["user"===e.role?(0,a.jsx)("p",{className:"whitespace-pre-wrap",children:e.content}):(0,a.jsx)(h.UG,{className:"prose prose-sm max-w-none prose-headings:text-gray-900 prose-p:text-gray-700",children:e.content}),(0,a.jsxs)("div",{className:"text-xs mt-3 ".concat("user"===e.role?"text-blue-100":"text-gray-500"),children:[e.timestamp.toLocaleTimeString(),e.model&&(0,a.jsxs)("span",{className:"ml-2",children:["• ",null===(t=p.find(t=>t.id===e.model))||void 0===t?void 0:t.name]})]})]}),"user"===e.role&&(0,a.jsx)("div",{className:"w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center flex-shrink-0",children:(0,a.jsx)(g.Z,{size:16,className:"text-white"})})]},e.id)}),b&&(0,a.jsxs)("div",{className:"flex gap-4",children:[(0,a.jsx)("div",{className:"w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0",children:(0,a.jsx)(r.Z,{size:16,className:"text-white"})}),(0,a.jsx)("div",{className:"bg-white rounded-2xl p-4 border border-gray-200",children:(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})]}),(0,a.jsx)("div",{ref:L})]}):(0,a.jsx)("div",{className:"h-full flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center max-w-md mx-auto px-6",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-black rounded-2xl flex items-center justify-center mx-auto mb-6",children:(0,a.jsx)(r.Z,{size:32,className:"text-white"})}),(0,a.jsx)("h2",{className:"text-3xl font-bold text-gray-900 mb-4",children:"What's in your mind?"}),(0,a.jsx)("p",{className:"text-gray-600 mb-8 text-lg",children:"Start a conversation with our AI assistant. Ask questions, get help, or just chat!"}),(0,a.jsxs)("div",{className:"text-sm text-gray-500 bg-white p-4 rounded-lg border border-gray-200",children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Model:"})," ",v.name]}),(0,a.jsx)("p",{children:v.description})]})]})})}),(0,a.jsx)("div",{className:"p-6 bg-white border-t border-gray-200",children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("textarea",{value:f,onChange:e=>y(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),handleSendMessage())},placeholder:"What's in your mind?",className:"w-full p-4 pr-14 border border-gray-200 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 placeholder-gray-500",rows:1,style:{minHeight:"56px",maxHeight:"160px"}}),(0,a.jsx)("button",{onClick:handleSendMessage,disabled:!f.trim()||b,className:"absolute right-2 bottom-2 p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,a.jsx)(m.Z,{size:18})})]}),(0,a.jsxs)("div",{className:"mt-3 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"text-xs text-gray-500",children:["Using ",v.name," • Press Enter to send, Shift+Enter for new line"]}),(0,a.jsx)("button",{onClick:testApiKeyDirect,className:"px-3 py-1 text-xs bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors",children:"\uD83E\uDDEA Test API"})]})]})})]})]})}}},function(e){e.O(0,[317,971,472,744],function(){return e(e.s=1609)}),_N_E=e.O()}]);