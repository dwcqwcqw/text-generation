# 语音功能配置指南

本项目已升级语音功能，支持 **Cloudflare R2 缓存**和**阿里云语音识别**。

## 🎯 功能特性

### 📁 文字转语音缓存
- ✅ 自动缓存生成的语音文件到 Cloudflare R2
- ✅ 相同文本直接使用缓存，避免重复调用 API
- ✅ 支持高质量 MP3 音频格式

### 🎤 阿里云语音识别
- ✅ 替换 RunPod Whisper，使用阿里云录音文件识别
- ✅ 支持多种音频格式（webm、mp3、wav 等）
- ✅ 自动语言检测，支持中英文

## 🔧 环境变量配置

### Cloudflare Pages 环境变量

在 Cloudflare Pages 控制台的 **Settings > Environment variables** 中添加：

#### 阿里云 ASR 配置
```bash
NEXT_PUBLIC_ALIYUN_ACCESS_KEY_ID=YOUR_ALIYUN_ACCESS_KEY_ID
NEXT_PUBLIC_ALIYUN_ACCESS_KEY_SECRET=YOUR_ALIYUN_ACCESS_KEY_SECRET
NEXT_PUBLIC_ALIYUN_APP_KEY=YOUR_ALIYUN_APP_KEY
```

#### Cloudflare R2 存储配置
```bash
R2_ACCOUNT_ID=YOUR_R2_ACCOUNT_ID
R2_ACCESS_KEY_ID=YOUR_R2_ACCESS_KEY_ID
R2_SECRET_ACCESS_KEY=YOUR_R2_SECRET_ACCESS_KEY
```

> **⚠️ 注意：请将上述 `YOUR_*` 替换为实际的配置值。具体的密钥值请从项目管理员处获取。**

## 🚀 部署步骤

1. **配置环境变量**：
   - 在 Cloudflare Pages 控制台添加上述环境变量
   - 确保所有变量都已正确设置

2. **重新部署**：
   - 保存环境变量后，Cloudflare Pages 会自动重新部署
   - 或者推送新代码触发重新部署

3. **验证功能**：
   - 测试文字转语音：发送消息后点击语音播放按钮
   - 测试语音转文字：点击麦克风录音并查看转录结果

## 📊 工作流程

### 文字转语音流程
1. **缓存检查**：首先检查 R2 中是否有相同文本的缓存
2. **直接播放**：如果有缓存，直接播放缓存的音频
3. **生成新音频**：如果无缓存，调用 MiniMax API 生成音频
4. **自动缓存**：将新生成的音频上传到 R2 缓存
5. **播放音频**：播放生成的音频

### 语音转文字流程
1. **录音上传**：将用户录音上传到 R2 获取公共 URL
2. **任务提交**：调用阿里云 ASR API 提交识别任务
3. **状态轮询**：每10秒查询一次任务状态（最多5分钟）
4. **结果获取**：获取识别结果并填入输入框
5. **文件清理**：识别完成后可选择清理临时文件

## 🔍 故障排除

### 常见问题

1. **语音转文字失败**：
   - 检查阿里云环境变量是否正确设置
   - 确认录音文件已成功上传到 R2
   - 查看浏览器控制台的错误信息

2. **文字转语音缓存失败**：
   - 检查 R2 环境变量配置
   - 确认 R2 存储桶权限设置正确
   - 验证公共访问 URL 是否可用

3. **构建失败**：
   - 确保所有环境变量都已在 Cloudflare Pages 中设置
   - 检查 package.json 中的依赖是否正确安装

### 调试技巧

1. **查看浏览器控制台**：所有语音操作都有详细的日志输出
2. **检查网络请求**：在开发者工具的 Network 标签中查看 API 调用
3. **验证环境变量**：确认所有必需的环境变量都已正确设置

## 🌟 性能优化

- **智能缓存**：相同文本的语音只生成一次
- **并行处理**：语音上传和识别并行进行
- **错误恢复**：网络错误时自动重试
- **用户体验**：提供实时状态反馈和进度提示

## 📝 备注

- R2 存储使用 S3 兼容 API，确保高可用性
- 阿里云 ASR 使用录音文件识别，支持长音频
- 所有 API 密钥通过环境变量管理，提高安全性
- 缓存机制显著减少 API 调用成本 